@page "/page/venta"

@using Microsoft.AspNetCore.Components.Authorization
@inject IProductoService _productoServicio
@inject IVentaService _ventaServicio
@inject IClienteService _clienteServicio
@inject ISnackbar _snackBar
@inject SweetAlertService Swal
@inject AuthenticationStateProvider _authStateProvider

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-5">

    <MudText Typo="Typo.h5" GutterBottom="true" Class="mb-4">Nueva Venta</MudText>

    <MudGrid>
        @* --- SECCIÓN 1: INFORMACIÓN DEL CLIENTE --- *@
        <MudItem xs="12" md="4">
            <MudCard Elevation="3" Class="pa-4" Style="height: 100%;">
                <MudText Typo="Typo.subtitle1" Class="mb-3"><b>1. Información del Cliente</b></MudText>
                <MudStack Spacing="3">
                    <MudSelect T="int?" Label="Seleccionar Cliente" @bind-Value="_venta.IdCliente"
                               Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true">
                        <MudSelectItem T="int?" Value="null">-- Cliente General --</MudSelectItem>
                        @foreach (var cli in _listaClientes)
                        {
                            <MudSelectItem T="int?" Value="@cli.IdCliente">@($"{cli.Nombre} ({cli.Celular})")</MudSelectItem>
                        }
                    </MudSelect>

                    <MudSelect T="string" Label="Tipo de Pago" Variant="Variant.Outlined"
                               @bind-Value="_venta.TipoPago" Margin="Margin.Dense">
                        <MudSelectItem Value="@("Efectivo")" />
                        <MudSelectItem Value="@("Transferencia")" />
                        <MudSelectItem Value="@("QR / Otros")" />
                    </MudSelect>

                    @* NUEVO: CAMPO MONTO RECIBIDO *@
                    <MudNumericField @bind-Value="_venta.MontoRecibido" Label="Monto Recibido (Abono)"
                                     Variant="Variant.Filled" Margin="Margin.Dense"
                                     Format="N2" Min="0" Color="Color.Success"
                                     HelperText="Ingrese cuánto paga el cliente ahora" />
                </MudStack>
            </MudCard>
        </MudItem>

        @* --- SECCIÓN 2: SELECCIÓN DE PRODUCTOS --- *@
        <MudItem xs="12" md="8">
            <MudCard Elevation="3" Class="pa-4">
                <MudText Typo="Typo.subtitle1" Class="mb-3"><b>2. Agregar Productos</b></MudText>
                <MudGrid Spacing="2">
                    <MudItem xs="12" sm="6">
                        <MudSelect T="ProductoDTO" Label="Producto" @bind-Value="_productoSeleccionado"
                                   Variant="Variant.Outlined" Margin="Margin.Dense" Dense="true">
                            @foreach (var pro in _listaProductos)
                            {
                                <MudSelectItem Value="@pro">@($"{pro.Nombre} - {pro.DescripcionCategoria}")</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>

                    <MudItem xs="6" sm="3">
                        <MudNumericField @bind-Value="_cantidad" Label="Cant. Unid."
                                         Variant="Variant.Outlined" Margin="Margin.Dense" Min="1" />
                    </MudItem>

                    <MudItem xs="6" sm="3">
                        <MudNumericField @bind-Value="_pesoTotal" Label="Peso (Kg)"
                                         Variant="Variant.Outlined" Step="1" Margin="Margin.Dense" Min="1"
                                         HelperText="Use rueda del mouse" />
                    </MudItem>

                    <MudItem xs="12">
                        <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Add"
                                   Color="Color.Info" FullWidth="true" Size="Size.Large"
                                   OnClick="AgregarProducto">Añadir al Carrito</MudButton>
                    </MudItem>
                </MudGrid>
            </MudCard>
        </MudItem>

        @* --- SECCIÓN 3: RESUMEN DE CARRITO Y FINALIZACIÓN --- *@
        <MudItem xs="12">
            <MudCard Elevation="3" Class="pa-2">
                <MudTable Items="@_venta.DetalleVenta" Dense="true" Striped="true" Bordered="false"
                          Breakpoint="Breakpoint.Sm" Elevation="0" Hover="true" Class="mb-4">
                    <HeaderContent>
                        <MudTh>Producto</MudTh>
                        <MudTh>Peso (Kg)</MudTh>
                        <MudTh>Precio</MudTh>
                        <MudTh>Total</MudTh>
                        <MudTh>Acción</MudTh>
                    </HeaderContent>
                    <RowTemplate Context="dvProducto">
                        <MudTd DataLabel="Producto">@dvProducto.DescripcionProducto</MudTd>
                        <MudTd DataLabel="Peso (Kg)">@dvProducto.PesoTotal</MudTd>
                        <MudTd DataLabel="Precio">@dvProducto.Precio Bs.</MudTd>
                        <MudTd DataLabel="Total"><b>@dvProducto.Total.Value.ToString("N2") Bs.</b></MudTd>
                        <MudTd DataLabel="Acción">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                           Variant="Variant.Outlined" Size="Size.Small"
                                           OnClick="@(() => EliminarProducto(dvProducto.IdProducto))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>

                <MudDivider Class="my-2" />

                <div class="pa-4">
                    <MudGrid>
                        <MudItem xs="12" sm="6">
                            <MudPaper Elevation="0" Class="pa-4 d-flex justify-center align-center rounded-lg"
                                      Style="background-color: #f8f9fa; border: 1px solid #dee2e6; height: 100%">
                                <MudText Typo="Typo.h5" Color="Color.Primary">
                                    <small style="font-size: 0.5em; vertical-align: middle;">TOTAL A PAGAR:</small>
                                    <b>Bs. @_venta.TotalTexto</b>
                                </MudText>
                            </MudPaper>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            @* INDICADOR DE SALDO PENDIENTE *@
                            <MudPaper Elevation="0" Class="pa-4 d-flex justify-center align-center rounded-lg"
                                      Style="@(GetSaldo() > 0 ? "background-color: #fff4e5; border: 1px solid #ffa117;" : "background-color: #e5f4ea; border: 1px solid #32a852;")">
                                <MudText Typo="Typo.h5" Color="@(GetSaldo() > 0 ? Color.Warning : Color.Success)">
                                    <small style="font-size: 0.5em; vertical-align: middle;">SALDO PENDIENTE:</small>
                                    <b>Bs. @GetSaldo().ToString("N2")</b>
                                </MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>

                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.CheckCircle"
                               Color="Color.Success" Size="Size.Large" FullWidth="true"
                               Style="height: 60px; font-size: 1.2rem; font-weight: bold;"
                               Class="mt-4"
                               OnClick="RegistrarVenta" Disabled="@botonDesactivado">
                        FINALIZAR REGISTRO
                    </MudButton>
                </div>
            </MudCard>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<ProductoDTO> _listaProductos = new List<ProductoDTO>();
    private List<ClienteDTO> _listaClientes = new List<ClienteDTO>();
    private int _cantidad = 1;
    private int _pesoTotal = 1;
    private bool botonDesactivado = false;
    private ProductoDTO _productoSeleccionado;
    private int _idUsuarioActual;

    VentaDTO _venta = new VentaDTO()
    {
        TipoPago = "Efectivo",
        IdCliente = null,
        MontoRecibido = 0, // Inicializar
        DetalleVenta = new List<DetalleVentaDTO>()
    };

    // Función para calcular el saldo en la interfaz
    private decimal GetSaldo()
    {
        decimal total = _venta.DetalleVenta?.Sum(v => v.Total) ?? 0;
        decimal recibido = _venta.MontoRecibido ?? 0;
        decimal saldo = total - recibido;
        return saldo < 0 ? 0 : saldo;
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await _authStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity.IsAuthenticated)
        {
            var claimId = user.Claims.Where(c => c.Type == "IdUsuario").FirstOrDefault();
            if (claimId != null)
                _idUsuarioActual = int.Parse(claimId.Value);
        }

        var responsePro = await _productoServicio.Lista();
        if (responsePro.status) _listaProductos = (List<ProductoDTO>)responsePro.value!;

        var responseCli = await _clienteServicio.ListaActivos();
        if (responseCli.status) _listaClientes = (List<ClienteDTO>)responseCli.value!;
    }

    private async Task AgregarProducto()
    {
        if (_productoSeleccionado != null && _pesoTotal > 0)
        {
            var detalleVenta = new DetalleVentaDTO()
            {
                IdProducto = _productoSeleccionado.IdProducto,
                DescripcionProducto = _productoSeleccionado.Nombre,
                Cantidad = _cantidad,
                PesoTotal = _pesoTotal,
                Precio = _productoSeleccionado.Precio,
                Total = (decimal)_pesoTotal * _productoSeleccionado.Precio
            };

            _venta.DetalleVenta!.Add(detalleVenta);
            _venta.Total = _venta.DetalleVenta.Sum(v => v.Total);

            // Al agregar productos, sugerimos que el monto recibido sea el total
            // (puedes quitar esta línea si prefieres que empiece siempre en 0)
            _venta.MontoRecibido = _venta.Total;

            _productoSeleccionado = null;
            _cantidad = 1;
            _pesoTotal = 1;
        }
        else
        {
            _snackBar.Add("Seleccione un producto y un peso válido", Severity.Info);
        }
    }

    private async Task EliminarProducto(int idproducto)
    {
        var productoEliminar = _venta.DetalleVenta.Find(p => p.IdProducto == idproducto);
        if (productoEliminar != null)
        {
            _venta.DetalleVenta.Remove(productoEliminar);
            _venta.Total = _venta.DetalleVenta.Sum(v => v.Total);
            _venta.MontoRecibido = _venta.Total; // Reajustar sugerencia de pago
        }
    }

    private async Task RegistrarVenta()
    {
        if (_venta.DetalleVenta.Count == 0)
        {
            _snackBar.Add("El carrito está vacío", Severity.Warning);
            return;
        }

        // Validación: Si hay saldo, obligar a seleccionar un cliente (no permitir anónimo)
        if (GetSaldo() > 0 && _venta.IdCliente == null)
        {
            await Swal.FireAsync("Atención", "Para ventas al crédito debe seleccionar un Cliente específico.", "warning");
            return;
        }

        botonDesactivado = true;
        _venta.IdUsuario = _idUsuarioActual;
        _venta.FechaRegistro = DateTime.Now;

        var response = await _ventaServicio.Registrar(_venta);

        if (response.status)
        {
            var _ventaCreada = (VentaDTO)response.value!;
            _venta = new VentaDTO()
            {
                TipoPago = "Efectivo",
                IdCliente = null,
                MontoRecibido = 0,
                DetalleVenta = new List<DetalleVentaDTO>()
            };

            await Swal.FireAsync("Venta Exitosa", $"Documento: {_ventaCreada.NumeroDocumento}", "success");
        }
        else
        {
            await Swal.FireAsync("Error", "No se pudo registrar la venta", "error");
        }
        botonDesactivado = false;
    }
}